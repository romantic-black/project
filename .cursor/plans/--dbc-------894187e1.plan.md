<!-- 894187e1-de2e-4ae4-89ac-0eee579b75aa 8c674a7e-ab82-4afa-a1fe-52cc05927080 -->
# 车载DBC实时显示系统实现计划

## 项目结构

### Monorepo 组织

- `pnpm-workspace.yaml`: 定义 apps/server、apps/web、packages/common 三个工作区
- `package.json`: 根工作区配置，包含 `dev`、`db:push`、`seed` 等脚本
- `packages/common/`: 共享类型定义、工具函数、Zod schema
- `apps/server/`: 后端服务
- `apps/web/`: 前端应用

## 后端实现（apps/server）

### 1. 项目基础配置

- `package.json`: ESM 配置，依赖 ws/socket.io、better-sqlite3、drizzle-orm、zod、dotenv、pino
- `tsconfig.json`: TypeScript ESM 配置
- `src/index.ts`: 启动入口，根据 DATA_MODE 选择数据源
- `src/config.ts`: 环境变量加载与验证（使用 zod）

### 2. CAN 数据源抽象层

- `src/can/ICanSource.ts`: 统一接口定义
  ```typescript
  interface ICanSource {
    start(): Promise<void>;
    stop(): Promise<void>;
    onFrame(callback: (frame: CanFrame) => void): void;
    stats(): { frames: number; errors: number };
  }
  ```

- `src/can/SocketCanSource.ts`: SocketCAN 实现（使用 `socketcan` 库，不可用时留 TODO 但保持接口）
- `src/can/VcanSource.ts`: vcan0 虚拟接口实现（复用 SocketCAN 逻辑）
- `src/can/ReplaySource.ts`: JSON 回放实现（按时间戳递增发送），PCAP/ASC 接口预留 TODO
- `src/can/MockSource.ts`: 基于 DBC 的周期模拟器，读取 GenMsgCycleTime，信号在 min/max 范围随机波动

### 3. DBC 解析与解码

- `src/dbc/loader.ts`: 读取 dbc/vehicle.json，提供消息/信号表查询
  - 消息表：ID、名称、发送者、周期时间
  - 信号表：factor、offset、bitStart、bitLen、endianness、units、VAL映射、注释
- `src/decoder/bitops.ts`: 位操作工具
  - `extractBits()`: 按位提取
  - `isBigEndian()`: 大小端判断
  - `applyScale()`: factor/offset 应用
  - `clamp()`: 限幅
- `src/decoder/checks.ts`: 健康检测
  - `checkLifeCnt()`: 0-15 循环溢出检测
  - `checkXorChecksum()`: Byte0-7 XOR 校验

### 4. 数据流水线

- `src/pipeline/normalize.ts`: 原始帧标准化
  - 输入：原始CAN帧
  - 输出：`{ msgId, name, timestamp, values: {sig: val}, raw, healthy }`
  - healthy 标记：LifeCnt/Checksum 失败时 false

### 5. 数据库层

- `src/db/schema.ts`: Drizzle schema
  - `frames_raw`: 原始帧（可选，用于调试）
  - `signals_agg_1s`: 1秒聚合（last/first/avg/max/min）
  - `signals_agg_10s`: 10秒聚合
  - `events_alarm`: 告警事件
- `src/db/repo.ts`: 数据访问层
  - `batchInsert()`: 批量写入优化
  - `cleanupTTL()`: TTL 清理（如保留7天）
  - `queryHistory()`: 时间窗查询（支持 step=1s/10s）

### 6. API 层

- `src/api/ws.ts`: WebSocket 服务（使用 ws 库）
  - 主题：`realtime/VCU`、`realtime/EEC1`、`realtime/overview` 等
  - 心跳机制：客户端 ping/pong
  - 背压控制：队列满时丢弃旧数据
- `src/api/rest.ts`: REST API
  - `GET /api/snapshot?signals=VCU_VehSpeed,VCU_BatSOC`: 当前快照
  - `GET /api/history?signals=...&from=...&to=...&step=1s`: 历史数据

## 前端实现（apps/web）

### 1. 项目基础

- `package.json`: React 18 + Vite + TypeScript，依赖 echarts、zustand、zod、dayjs、tailwindcss
- `vite.config.ts`: 代理配置（代理到后端 HTTP/WS）
- `src/main.tsx`: 入口，路由配置（React Router）

### 2. 数据层

- `src/stores/telemetry.ts`: Zustand store，管理实时/历史数据
- `src/hooks/useWebSocket.ts`: WebSocket 客户端封装，自动重连，队列限制
- `src/services/api.ts`: REST API 调用封装

### 3. 页面组件

- `src/pages/Dashboard.tsx`: 仪表盘
  - 车速：仪表盘 + 折线图
  - 转速：仪表盘 + 微火花线
  - SOC/燃料：环形进度条（ECharts gauge）
  - 挡位/模式：Badge 枚举显示
  - 故障等级：颜色卡片（0-Normal, 1-3 红/橙/黄）
  - 在线状态：心跳指示灯
- `src/pages/Engine.tsx`: 发动机页面
  - EEC1/2 折线图（扭矩、转速、负载等）
  - 枚举标签（EngineTorqueMode、EngineStarterMode）
- `src/pages/VCU.tsx`: VCU 信息
  - 角速度/制动压力折线
  - 驻车/模式切换状态格
  - 里程卡片
- `src/pages/ISG.tsx`: ISG 信息
  - 电压/电流/功率联动图表
  - 转速/扭矩双Y轴折线
- `src/pages/Hydraulic.tsx`: 液压系统
  - Hyd_*Sts 状态矩阵（表格）
  - 转向角度表盘
- `src/pages/Alarms.tsx`: 告警页面
  - 灯指示状态列表（红/黄/OBD）
  - 筛选与时间窗查看
- `src/pages/Signals.tsx`: 信号浏览器
  - 基于 DBC 展示：单位、范围、注释、VAL 映射

### 4. UI 组件

- `src/components/StatusBadge.tsx`: 状态徽章（模式/挡位）
- `src/components/HeartbeatIndicator.tsx`: 心跳指示灯
- `src/components/SignalCard.tsx`: 信号卡片（值+单位+趋势）
- `src/components/ChartContainer.tsx`: ECharts 容器封装（响应式）

### 5. 工具函数

- `src/utils/dbc.ts`: DBC 值映射（VAL_TABLE_ 到中文显示）
- `src/utils/format.ts`: 单位格式化（℃、Mpa、％、deg、km/h、rpm）
- `src/utils/time.ts`: 时区与时间格式统一

## 公共包（packages/common）

- `packages/common/src/types.ts`: 共享类型（CanFrame、SignalValue、MessageData 等）
- `packages/common/src/zod.ts`: Zod schema（用于前后端验证）
- `packages/common/package.json`: 独立包配置

## 脚本与工具

### DBC 转换脚本

- `scripts/dbc-to-json/dbc-to-json.py`: Python 脚本（使用 cantools）
  - 解析 AutoCtrl_V10_28.dbc
  - 输出 `dbc/vehicle.json`（JSON Schema 包含消息、信号、VAL 表、注释）
  - README 说明使用方法与依赖安装

### 数据样例

- `samples/replay.json`: JSON 格式回放文件示例
  ```json
  [
    {"timestamp": 0, "id": 320, "data": [0x01, 0x02, ...]},
    {"timestamp": 100, "id": 321, "data": [...]}
  ]
  ```


### 数据库脚本

- `apps/server/src/scripts/seed.ts`: 写入演示数据（pnpm seed）
- `apps/server/src/scripts/migrate.ts`: Drizzle 迁移（pnpm db:push）

## 配置文件

### 环境变量

- `.env.example`: 完整配置模板
  ```
  DATA_MODE=socketcan|vcan|replay|mock
  CAN_IFACE=can0|vcan0
  WS_PORT=8080
  HTTP_PORT=3000
  DB_PATH=./data/telemetry.db
  REPLAY_FILE=./samples/replay.json
  DBC_JSON=./dbc/vehicle.json
  ```


### 根脚本

- `package.json` scripts:
  - `dev`: 并发启动 server 和 web
  - `db:push`: 初始化数据库表
  - `seed`: 写入演示数据

## README.md

包含以下章节：

1. 项目概述
2. 技术栈
3. 快速开始（pnpm i && pnpm dev）
4. WSL vcan 测试步骤

   - 安装 can-utils
   - 创建 vcan0：`sudo modprobe vcan && sudo ip link add dev vcan0 type vcan && sudo ip link set up vcan0`
   - 设置 DATA_MODE=vcan 运行
   - 使用 cangen/cansend 验证

5. 回放测试（DATA_MODE=replay）
6. 实车部署（SocketCAN）

   - systemd 服务配置示例
   - pm2 配置示例

7. API 文档
8. 故障排查

## 质量保证

- 端到端：Dashboard 能显示所有关键信号并随数据源变化
- 性能：单源 1000 FPS 输入，后端限流推送（可配置队列大小），前端防抖渲染
- 健壮性：数据源切换无需重启前端；无数据时友好降级；配置缺失时明确日志（使用 pino）

## 实现优先级

1. 项目结构与配置
2. DBC 解析脚本与 JSON 生成
3. 数据源抽象层（MockSource 先实现，便于测试）
4. 解码与流水线
5. 数据库 schema 与写入
6. WebSocket/REST API
7. 前端核心页面（Dashboard → Engine → 其他页面）
8. 测试与文档

### To-dos

- [ ] 创建 monorepo 结构：pnpm-workspace.yaml、根 package.json、packages/common、apps/server、apps/web 目录
- [ ] 实现 DBC 转换脚本 scripts/dbc-to-json/dbc-to-json.py，将 DBC 解析为 dbc/vehicle.json
- [ ] 后端：实现 ICanSource 接口、MockSource（周期模拟器）、ReplaySource（JSON回放），以及配置系统
- [ ] 后端：实现 DBC loader、解码器（bitops、checks）、数据流水线（normalize）
- [ ] 后端：实现数据库 schema（Drizzle）、repo（批量写入、查询、TTL清理）、初始化脚本
- [ ] 后端：实现 WebSocket 服务（主题订阅、心跳、背压）和 REST API（snapshot、history）
- [ ] 后端：实现 SocketCanSource/VcanSource（SocketCAN 库集成，不可用时留 TODO 但保持接口）
- [ ] 前端：项目初始化（Vite+React+TS）、路由、Zustand store、WebSocket hook、API 服务
- [ ] 前端：实现 Dashboard 页面（车速/转速仪表、SOC/燃料环形图、挡位/模式/故障/在线状态）
- [ ] 前端：实现 Engine、VCU、ISG、Hydraulic、Alarms、Signals 页面
- [ ] 创建 .env.example、README.md（包含 WSL 测试、实车部署步骤）、samples/replay.json 示例
- [ ] 实现根 package.json 脚本（dev、db:push、seed），确保 pnpm i && pnpm dev 可运行