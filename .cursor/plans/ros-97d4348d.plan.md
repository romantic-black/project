<!-- 97d4348d-14e5-480f-8747-00867bcdbb4e 973fe20a-cc44-474f-8037-302a52b810a3 -->
# 控制页面地图与ROS集成（ROS1 Noetic）

## 概述

为控制页面添加离线地图功能，实现与ROS1 Noetic的双向通信。包括：点击地图发送交互目标点、接收GPS/RTK位置、显示Waypoint、显示轨迹、显示地形地图（障碍物）。支持rosbridge已安装和未安装两种情况。

## ROS 主题信息（基于ROS系统分析）

### 已确认的主题和消息类型

#### 位置信息主题

- **`/state_estimation`** (推荐)
- 发布节点：`/loaminterface`
- 消息类型：可能是 `nav_msgs/Odometry` 或 `geometry_msgs/PoseStamped`（需运行时确认）
- 坐标系：`map` frame
- 说明：车辆在map坐标系下的位置状态，优先使用此主题获取车辆位置

- **`/chcnav_fix_demo/fix`** (备用)
- 消息类型：`sensor_msgs/NavSatFix`
- 坐标系：WGS84（GPS原始坐标）
- 说明：GPS/RTK原始位置，如使用需要转换到map坐标系

#### 轨迹主题

- **`/path`**
- 发布节点：`/localPlanner`
- 消息类型：`nav_msgs/Path`
- 坐标系：`map` frame
- 说明：规划出的行驶轨迹，标准ROS轨迹话题

#### Waypoint和目标点主题

- **`/way_point`**
- 订阅节点：`/localPlanner`
- 消息类型：`geometry_msgs::PointStamped`
- 坐标系：`map` frame
- 说明：前端需要发布到此主题发送交互目标点（地图点击的目标）

#### 地形地图/障碍物主题

- **`/terrain_map`**
- 发布节点：`/terrainAnalysis`
- 消息类型：`sensor_msgs::PointCloud2`
- 坐标系：`map` frame
- 发布频率：5Hz

#### 速度命令主题

- **`/cmd_vel`**
- 发布节点：`/localPlanner` 和 `/pathFollower`
- 消息类型：`geometry_msgs::TwistStamped`
- 发布频率：50Hz

#### 图像主题（可选）

- **`/camera3/image/compressed`**
- 发布节点：`/camera3`
- 消息类型：`sensor_msgs/CompressedImage`
- 说明：摄像头3的压缩图像，可用于控制页面显示

#### 其他可用摄像头

- `/camera0/image/compressed`, `/camera1/image/compressed`, `/camera2/image/compressed` 等也存在

### ROS TF树信息

- `map` 是全局坐标系（global reference frame）
- `/chcnav_fix_demo` 节点发布 `map` -> `chcnav` 的变换
- `/loaminterface` 节点发布 `map` -> `sensor` 的变换
- 可通过TF树获取坐标系之间的变换关系

### 仍需确认的信息

1. **`/state_estimation` 的确切消息类型**：需要运行时确认是 `nav_msgs/Odometry` 还是 `geometry_msgs/PoseStamped`
2. **rosbridge WebSocket地址**：rosbridge_server的运行地址和端口（默认通常是 `ws://localhost:9090`）
3. **map坐标系原点信息**：map坐标系的原点、分辨率和范围（用于地图显示），要在前端界面通过人性化的方式设置，原点初始设置在车辆位置
4. **栅格地图信息**：如果使用ROS map_server，需要确认地图服务和map文件路径

### rosbridge处理方案

- **如果已安装rosbridge_server**：前端直接通过roslibjs连接到rosbridge WebSocket
- **如果未安装rosbridge_server**：
- 显示连接错误提示
- 提供安装指引：`sudo apt-get install ros-noetic-rosbridge-suite`
- 提供启动命令：`roslaunch rosbridge_server rosbridge_websocket.launch`
- （可选）实现服务器端ROS桥接代理作为备选方案

## 实现步骤

### 1. 安装依赖

- **前端**：
- `leaflet` + `react-leaflet` - 离线地图库
- `@types/leaflet` - TypeScript类型
- `roslibjs` - ROS1 WebSocket客户端库（用于连接rosbridge）

### 2. ROS通信服务

- **文件**: `apps/web/src/services/ros.ts`
- **功能**:
- 连接到rosbridge WebSocket（配置化地址）
- 检测连接状态（成功/失败/未连接）
- 订阅主题：
- `/state_estimation` - 车辆位置（主要，map坐标系）
- `/chcnav_fix_demo/fix` - GPS原始位置（备用，WGS84）
- `/way_point` - Waypoint列表
- `/path` - 规划轨迹（`nav_msgs/Path`）
- `/terrain_map` - 地形地图/障碍物（`sensor_msgs/PointCloud2`, 5Hz）
- `/camera3/image/compressed` - 摄像头图像（可选）
- 发布主题：
- `/way_point` - 交互目标点，发送 `geometry_msgs::PointStamped`（header.frame_id="map"）
- ROS消息类型转换（JSON <-> ROS message）
- 错误处理和重连机制
- 处理 `/state_estimation` 的不同可能消息类型（`nav_msgs/Odometry` 或 `geometry_msgs/PoseStamped`）

### 3. 地图状态管理

- **文件**: `apps/web/src/stores/map.ts`
- **功能**:
- 存储车辆当前位置（map坐标系，来自 `/state_estimation`）
- 存储GPS/RTK原始位置（WGS84，来自 `/chcnav_fix_demo/fix`，可选）
- 存储目标地点（交互点击的目标，准备发布到 `/way_point`）
- 存储Waypoint列表（来自 `/way_point` 订阅）
- 存储轨迹路径点数组（来自 `/path`，`nav_msgs/Path`）
- 存储地形地图点云数据（来自 `/terrain_map`，用于障碍物显示）
- 存储ROS连接状态
- 处理位置信息的坐标转换（如果需要）

### 4. 地图组件

- **文件**: `apps/web/src/components/MapContainer.tsx`
- **功能**:
- 使用Leaflet渲染离线地图
- 支持自定义栅格地图瓦片或使用ROS提供的栅格地图
- 点击地图选择交互目标点，转换为map坐标系并发布到 `/way_point` 主题
- 显示车辆当前位置（从 `/state_estimation` 接收，map坐标系）
- 显示Waypoint标记（从 `/way_point` 订阅）
- 显示行驶轨迹（从 `/path` 订阅，`nav_msgs/Path` 格式）
- 显示地形地图点云（从 `/terrain_map` 接收，障碍物可视化，简化显示为区域标记）
- 处理位置信息的实时更新和轨迹的平滑绘制

### 5. ROS WebSocket Hook

- **文件**: `apps/web/src/hooks/useRosWebSocket.ts`
- **功能**:
- 连接到rosbridge（独立于CAN WebSocket）
- 检测rosbridge连接状态（已安装/未安装/连接失败）
- 管理ROS主题订阅/取消订阅
- 处理ROS消息接收和分发到store
- 提供发布消息的接口
- 自动重连机制

### 6. ROS连接状态组件

- **文件**: `apps/web/src/components/RosConnectionStatus.tsx`
- **功能**:
- 显示ROS连接状态（已连接/连接中/失败）
- 显示订阅的主题状态（哪些主题有数据，哪些没有）
- 如果连接失败，显示错误信息和安装指引
- 提供rosbridge安装命令：`sudo apt-get install ros-noetic-rosbridge-suite`
- 提供启动命令：`roslaunch rosbridge_server rosbridge_websocket.launch`
- 显示当前连接的rosbridge地址
- 显示关键主题的数据接收状态（如 `/state_estimation`, `/path`, `/terrain_map`）

### 7. 坐标转换工具

- **文件**: `apps/web/src/utils/coordinates.ts`
- **功能**:
- Map坐标系与显示坐标的转换
- 从 `/state_estimation` 提取位置（支持 `nav_msgs/Odometry` 和 `geometry_msgs/PoseStamped`）
- GPS坐标（WGS84）到map坐标系的转换（如果使用 `/chcnav_fix_demo/fix`）
- 处理map坐标系原点偏移
- 从 `nav_msgs/Path` 提取路径点坐标
- 地图点击坐标转换为map坐标系（用于发布 `/way_point`）

### 8. 更新控制页面

- **文件**: `apps/web/src/pages/Control.tsx`
- **功能**:
- 集成地图组件（占据主要区域）
- 集成ROS连接状态组件
- 显示地图控制面板（可选：清除轨迹、重置目标等）
- 显示GPS状态和ROS连接状态

### 9. 点云数据可视化优化

- **功能**:
- 对 `/terrain_map` 点云数据进行简化处理
- 转换为Leaflet可显示的障碍物区域（多边形或圆）
- 降低渲染负担（5Hz更新频率）
- 使用空间分区或聚类算法优化点云显示

### 10. 服务器端ROS桥接（可选）

- **文件**: `apps/server/src/ros/bridge.ts`
- **功能**:
- 仅在rosbridge未安装时考虑使用
- 使用roslib或其他ROS客户端库连接到ROS master
- 订阅/发布ROS主题
- 通过WebSocket转发消息到前端
- 需要Node.js环境能够访问ROS master

## 技术细节

### ROS 消息格式（基于系统分析）

- **Waypoint**: `geometry_msgs/PointStamped`
- 格式：`{header: {frame_id: "map", stamp: {...}}, point: {x, y, z}}`
- 主题：`/way_point`（前端发布，`/localPlanner` 订阅）

- **位置信息 - `/state_estimation`** (主要)
- 消息类型：`nav_msgs/Odometry` 或 `geometry_msgs/PoseStamped`（需运行时确认）
- 坐标系：`map` frame
- 发布节点：`/loaminterface`
- 说明：推荐使用此主题获取车辆位置（已在map坐标系中）

- **位置信息 - `/chcnav_fix_demo/fix`** (备用)
- 消息类型：`sensor_msgs/NavSatFix`
- 格式：`{header: {...}, latitude, longitude, altitude, ...}`
- 坐标系：WGS84（GPS原始坐标）
- 说明：如使用需要转换到map坐标系

- **轨迹**: `nav_msgs/Path`
- 格式：`{header: {frame_id: "map"}, poses: [{pose: {position: {x, y, z}, orientation: {...}}}, ...]}`
- 主题：`/path`（由 `/localPlanner` 发布）

- **地形地图**: `sensor_msgs/PointCloud2`
- 主题：`/terrain_map`（由 `/terrainAnalysis` 发布，5Hz）
- 坐标系：`map` frame

- **速度命令**: `geometry_msgs/TwistStamped`
- 主题：`/cmd_vel`（由 `/localPlanner` 和 `/pathFollower` 发布，50Hz）

- **交互目标**: `geometry_msgs::PointStamped`
- 主题：`/way_point`（前端发布）

- **图像**: `sensor_msgs/CompressedImage`
- 主题：`/camera3/image/compressed` 等

### 离线地图方案

- **方案1**：使用Leaflet + 离线瓦片地图（需提前下载区域瓦片）
- **方案2**：使用ROS map_server提供的栅格地图（通过 `nav_msgs/GetMap` 服务或直接加载map文件）
- **方案3**：纯坐标显示（无底图，仅显示标记和路径，使用GPS定位）

### 地图坐标系

- 使用ROS map坐标系（固定坐标系，不是WGS84）
- GPS数据来自RTK，通过 `/loaminterface` 已转换到map坐标系
- `/state_estimation` 已在map坐标系中，可直接使用
- 地图显示需要根据实际map坐标系范围调整视图

## 配置项

在 `.env` 或配置文件中添加：

- `ROS_BRIDGE_URL`: rosbridge WebSocket地址（如 `ws://localhost:9090`，如果未安装rosbridge可留空）
- `ROS_MASTER_URI`: ROS master URI（如果使用服务器端桥接，如 `http://localhost:11311`）
- `MAP_FRAME`: 地图坐标系frame名称（默认 `map`）
- `MAP_IMAGE_URL`: 栅格地图图片URL（如果使用方案2）

## 关键依赖关系

1. **位置信息来源**：

- 主要使用 `/state_estimation`（map坐标系，由 `/loaminterface` 发布）
- 备用 `/chcnav_fix_demo/fix`（WGS84坐标系，需要转换到map坐标系）

2. **轨迹来源**：`/path` 主题（`nav_msgs/Path`，由 `/localPlanner` 发布）
3. **目标点发布**：前端发布到 `/way_point` 主题（`geometry_msgs::PointStamped`，frame_id="map"）
4. rosbridge_server 可能已安装，也可能需要安装
5. 前端通过roslibjs连接到rosbridge（如果可用）
6. 所有坐标都在map坐标系中，需要正确的坐标转换
7. 点云数据需要简化以降低渲染负担（5Hz更新频率）
8. 需要处理rosbridge未安装的情况，提供清晰的错误提示和安装指引
9. 需要处理 `/state_estimation` 消息类型的不确定性（`nav_msgs/Odometry` 或 `geometry_msgs/PoseStamped`）

## 用户体验

- 如果rosbridge未安装：显示友好的错误提示和安装步骤
- 如果rosbridge已安装但未运行：提示启动命令
- 连接成功后：正常显示地图和ROS数据
- 连接断开：自动尝试重连，显示重连状态
- 显示各主题的数据接收状态，便于调试

## ROS节点和话题关系总结

基于ROS计算图分析：

- `/loaminterface` 发布 `/state_estimation` → 车辆位置信息（主要数据源）
- `/localPlanner` 订阅 `/way_point` → 接收前端发送的目标点
- `/localPlanner` 发布 `/path` → 规划轨迹
- `/terrainAnalysis` 发布 `/terrain_map` → 地形地图/障碍物
- `/camera3` 发布 `/camera3/image/compressed` → 摄像头图像
- TF树：`map` 作为全局坐标系，可通过TF获取坐标变换

### To-dos

- [ ] 安装地图库和 ROS 相关依赖（Leaflet, react-leaflet, 类型定义）
- [ ] 创建地图状态管理 store（位置、目标、轨迹、障碍物）
- [ ] 创建 ROS 通信服务，实现连接、订阅、发布功能
- [ ] 创建地图组件，集成 Leaflet，支持点击、标记、轨迹绘制
- [ ] 在控制页面集成地图组件，处理地图交互和 ROS 通信
- [ ] 实现轨迹显示功能，在地图上绘制历史路径
- [ ] 实现障碍物显示功能，在地图上标记障碍物位置